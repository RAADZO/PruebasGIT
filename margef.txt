Option Explicit

Public Sub ReportePorCadaID_BloquesTablas_SoloGuionBajo()
    Dim wb As Workbook: Set wb = ThisWorkbook
    Dim wsParam As Worksheet
    Dim ids As Object
    Dim lastRow As Long, i As Long, idTxt As String

    On Error Resume Next
    Set wsParam = wb.Worksheets("Parametros")
    On Error GoTo 0

    If wsParam Is Nothing Then
        MsgBox "No existe la hoja 'Parametros'.", vbExclamation
        Exit Sub
    End If

    Set ids = CreateObject("Scripting.Dictionary")
    ids.CompareMode = 1 ' vbTextCompare

    lastRow = wsParam.Cells(wsParam.Rows.Count, "A").End(xlUp).Row
    If lastRow < 2 Then
        MsgBox "No hay IDs en 'Parametros' (A2:A).", vbExclamation
        Exit Sub
    End If

    For i = 2 To lastRow
        idTxt = Trim(CStr(wsParam.Cells(i, "A").Value))
        If idTxt <> "" Then
            If Not ids.Exists(idTxt) Then ids.Add idTxt, True
        End If
    Next i

    If ids.Count = 0 Then
        MsgBox "No se cargó ningún ID válido.", vbExclamation
        Exit Sub
    End If

    Application.ScreenUpdating = False
    Application.EnableEvents = False

    Dim k As Variant
    For Each k In ids.Keys
        GenerarReporteParaUnID CStr(k), wsParam, wb
    Next k

    Application.EnableEvents = True
    Application.ScreenUpdating = True

    MsgBox "Listo. Se generaron " & ids.Count & " reportes (1 por ID).", vbInformation
End Sub


Private Sub GenerarReporteParaUnID(ByVal theID As String, ByVal wsParam As Worksheet, ByVal wb As Workbook)
    Dim wsOut As Worksheet
    Dim reportName As String
    reportName = MakeSafeSheetName("RPT_" & theID)

    Set wsOut = GetOrCreateSheet(wb, reportName)
    wsOut.Cells.Clear

    wsOut.Cells(1, 1).Value = "Report for ID:"
    wsOut.Cells(1, 2).Value = theID
    wsOut.Rows(1).Font.Bold = True

    Dim outRow As Long: outRow = 3

    Dim ws As Worksheet, lo As ListObject
    Dim idCol As Long, c As Long, r As Long
    Dim colsToExport As Collection
    Dim hasAnyUnderscore As Boolean
    Dim matchCount As Long
    Dim outCol As Long
    Dim colIdx As Variant
    Dim idVal As String
    Dim colName As String, headerOut As String

    For Each ws In wb.Worksheets
        If ws.Name <> wsParam.Name And ws.Name <> wsOut.Name Then

            For Each lo In ws.ListObjects
                idCol = FindColumnIndexByHeader(lo, "ID")
                If idCol = 0 Then GoTo NextTable
                If lo.DataBodyRange Is Nothing Then GoTo NextTable

                ' Columnas: ID + solo las que empiezan por "_"
                Set colsToExport = New Collection
                colsToExport.Add idCol
                hasAnyUnderscore = False

                For c = 1 To lo.ListColumns.Count
                    If c <> idCol Then
                        colName = Trim$(CStr(lo.ListColumns(c).Name))  ' <-- FIX: nombre robusto
                        If Len(colName) > 0 Then
                            If Left$(colName, 1) = "_" Then
                                colsToExport.Add c
                                hasAnyUnderscore = True
                            End If
                        End If
                    End If
                Next c

                If Not hasAnyUnderscore Then GoTo NextTable

                ' Contar matches
                matchCount = 0
                For r = 1 To lo.DataBodyRange.Rows.Count
                    idVal = Trim$(CStr(lo.DataBodyRange.Cells(r, idCol).Value))
                    If StrComp(idVal, theID, vbTextCompare) = 0 Then matchCount = matchCount + 1
                Next r

                If matchCount = 0 Then GoTo NextTable

                ' Título bloque
                wsOut.Cells(outRow, 1).Value = "Sheet: " & ws.Name & " | Table: " & lo.Name & " | Matches: " & matchCount
                wsOut.Cells(outRow, 1).Font.Bold = True
                outRow = outRow + 1

                ' Headers del bloque (ahora sí salen)
                outCol = 1
                For Each colIdx In colsToExport
                    colName = Trim$(CStr(lo.ListColumns(CLng(colIdx)).Name)) ' <-- FIX
                    headerOut = colName
                    ' Si quieres quitar el "_" en el reporte, déjalo así:
                    If Left$(headerOut, 1) = "_" Then headerOut = Mid$(headerOut, 2)

                    wsOut.Cells(outRow, outCol).Value = headerOut
                    wsOut.Cells(outRow, outCol).Font.Bold = True
                    outCol = outCol + 1
                Next colIdx
                outRow = outRow + 1

                ' Filas
                For r = 1 To lo.DataBodyRange.Rows.Count
                    idVal = Trim$(CStr(lo.DataBodyRange.Cells(r, idCol).Value))
                    If StrComp(idVal, theID, vbTextCompare) = 0 Then
                        outCol = 1
                        For Each colIdx In colsToExport
                            wsOut.Cells(outRow, outCol).Value = lo.DataBodyRange.Cells(r, CLng(colIdx)).Value
                            outCol = outCol + 1
                        Next colIdx
                        outRow = outRow + 1
                    End If
                Next r

                outRow = outRow + 2 ' 2 líneas entre tablas

NextTable:
            Next lo
        End If
    Next ws

    wsOut.Columns.AutoFit
End Sub


Private Function FindColumnIndexByHeader(ByVal lo As ListObject, ByVal headerName As String) As Long
    Dim c As Long, nm As String
    FindColumnIndexByHeader = 0

    ' Mejor buscar por el nombre real de la columna (ListColumns.Name)
    For c = 1 To lo.ListColumns.Count
        nm = Trim$(CStr(lo.ListColumns(c).Name))
        If StrComp(nm, headerName, vbTextCompare) = 0 Then
            FindColumnIndexByHeader = c
            Exit Function
        End If
    Next c
End Function

Private Function GetOrCreateSheet(ByVal wb As Workbook, ByVal sheetName As String) As Worksheet
    On Error Resume Next
    Set GetOrCreateSheet = wb.Worksheets(sheetName)
    On Error GoTo 0

    If GetOrCreateSheet Is Nothing Then
        Set GetOrCreateSheet = wb.Worksheets.Add(After:=wb.Worksheets(wb.Worksheets.Count))
        GetOrCreateSheet.Name = sheetName
    End If
End Function

Private Function MakeSafeSheetName(ByVal s As String) As String
    Dim badChars As Variant, ch As Variant
    badChars = Array(":", "\", "/", "?", "*", "[", "]")

    For Each ch In badChars
        s = Replace(s, CStr(ch), "_")
    Next ch

    s = Trim$(s)
    If Len(s) = 0 Then s = "RPT"
    If Len(s) > 31 Then s = Left$(s, 31)

    MakeSafeSheetName = s
End Function